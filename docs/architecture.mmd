classDiagram
class Main {
  +start(stage: Stage) : void
  +main(args: String[]) : void
  -navigator : SceneController
}

class SceneController {
  +navigateTo(id: SceneId, t: TransitionStrategy) : void
  +showMenu() : void
  +showSettings() : void
  +showGame() : void
  +showGameRound(round: int) : void
  +startGameFromSnapshot(snap: GameStateSnapshot) : void
  +showGameOver() : void
  +showWin() : void
  +showLogin() : void
  +showSignup() : void
  +showRankings() : void
  +saveInProgressIfAny() : void
  +exit() : void
}

class GameController {
  +initialize() : void
  +applySnapshot(snap: GameStateSnapshot) : void
  +resumeWithCountdown() : void
  +isResumable() : boolean
  +captureSnapshot() : GameStateSnapshot
  +stop() : void
  +getScore() : int
  -gameService : GameService
  -gameState : GameState
}

class MenuController {
  +onStartGame(e: ActionEvent) : void
  +onContinueGame(e: ActionEvent) : void
  +onOpenSettings(e: ActionEvent) : void
  +onShowRanking(e: ActionEvent) : void
  +onExit(e: ActionEvent) : void
}

class LoginController {
  +onLogin(e: ActionEvent) : void
  +onBack(e: ActionEvent) : void
}

class SignupController {
  +onSignup(e: ActionEvent) : void
  +onBack(e: ActionEvent) : void
}

class SettingsController {
  +initialize() : void
  +onBack(e: ActionEvent) : void
}

class RankingsController {
  +initialize() : void
}

class PauseController {
  +onResume(e: ActionEvent) : void
  +onRestart(e: ActionEvent) : void
  +onExit(e: ActionEvent) : void
}

class GameOverController {
  +onPlayAgain(e: ActionEvent) : void
  +onMainMenu(e: ActionEvent) : void
}

class WinController {
  +onShowRankings(e: ActionEvent) : void
  +onMainMenu(e: ActionEvent) : void
}

class GameService {
  +update(state: GameState, in: InputState, dt: double, worldW: double, worldH: double) : void
  +restartLevel(state: GameState) : void
  +loadNextLevel(state: GameState) : void
  +startNextLevel(state: GameState) : void
  +loadLevel(state: GameState, levelIndex: int) : void
  +bindState(state: GameState) : void
  +getEnemyService() : EnemyService
}

class BallService {
  +launch(ball: Ball) : void
  +step(ball: Ball, dt: double) : void
  +bounceWorld(ball: Ball, worldW: double, worldH: double) : void
  +fellBelow(ball: Ball, worldH: double) : boolean
  +resetOnPaddle(ball: Ball, paddle: Paddle) : void
  +bounceOff(ball: Ball, other: GameObject) : void
}

class PaddleService {
  +moveLeft(p: Paddle, dt: double, worldW: double) : void
  +moveRight(p: Paddle, dt: double, worldW: double) : void
  +clampWithin(p: Paddle, worldW: double) : void
  +stop(p: Paddle) : void
  +scaleWidth(p: Paddle, factor: double, worldW: double) : void
  +resetPaddlePosition(p: Paddle) : void
}

class BricksService {
  +createBricksFromLayout(layout: int[][]) : List
  +createBricksFromResource(resourcePath: String) : List
  +handleBrickHit(brick: Brick) : boolean
  +allBricksCleared(bricks: List) : boolean
  +getBricksRemaining() : int
  +recalculateBricksRemaining(bricks: List) : void
}

class BulletService {
  +tickCooldown(state: GameState, dt: double) : void
  +tryFire(state: GameState, paddle: Paddle) : boolean
  +update(state: GameState, bricks: List, dt: double, worldH: double) : List
}

class PowerUpService {
  +spawnPowerUpIfAny(x: double, y: double, width: double) : PowerUp
  +update(state: GameState, dt: double, worldW: double, worldH: double) : void
}

class EnemyService {
  +spawnEnemy(state: GameState, x: double, y: double) : void
  +update(state: GameState, dt: double, worldW: double, worldH: double) : void
}

class RoundService {
  +loadLevel(state: GameState, levelIndex: int) : void
  +loadNextLevel(state: GameState) : void
}

class DatabaseService {
  +initializeSchema() : CompletableFuture
  +login(username: String, password: String) : CompletableFuture
  +signup(username: String, password: String) : CompletableFuture
  +getRankings(limit: int) : CompletableFuture
  +loadInProgressState(userId: int) : CompletableFuture
  +saveInProgress(userId: int, snap: GameStateSnapshot) : CompletableFuture
  +clearInProgress(userId: int) : CompletableFuture
  +updateBest(userId: int, bestRound: int, bestScore: int) : CompletableFuture
  +shutdown() : void
}

class GameState {
  +resetForLife() : void
  +resetForLevel() : void
  +decrementScore(amount: int) : void
  +decrementLives() : void
  +incrementLives() : void
  +ball : Ball
  +paddle : Paddle
  +bricks : List
  +balls : List
  +bullets : List
  +powerUps : List
  +enemies : List
  +activePowerUps : Map
  +score : int
  +highScore : int
  +lives : int
  +level : int
  +running : boolean
  +paused : boolean
  +levelTransitionPending : boolean
  +timeScale : double
  +basePaddleWidth : double
  +basePaddleSpeed : double
  +laserCooldown : double
}

class GameStateSnapshot {
  +from(state: GameState) : GameStateSnapshot
  +applyTo(state: GameState) : void
  +currentLevel : int
  +score : int
  +lives : int
  +paddleX : double
  +ballX : double
  +ballY : double
  +ballDx : double
  +ballDy : double
  +ballMoving : boolean
  +ballDownward : boolean
  +ballStuck : boolean
  +ballStuckOffsetX : double
  +paddleWidth : double
  +timeScale : double
  +laserCooldown : double
}

class GameObject {
  +update(dt: double) : void
  +getX() : double
  +getY() : double
  +getWidth() : double
  +getHeight() : double
  -x : double
  -y : double
  -width : double
  -height : double
}

class MovableObject {
  +update(dt: double) : void
  +setVelocity(dx: double, dy: double) : void
  +getDx() : double
  +getDy() : double
  -dx : double
  -dy : double
}

class Ball {
  +getCenterX() : double
  +getCenterY() : double
  +setCenter(x: double, y: double) : void
  +getRadius() : double
  +setRadius(r: double) : void
  +isMoving() : boolean
  +setMoving(m: boolean) : void
  +isStuck() : boolean
  +setStuck(v: boolean) : void
  +getStuckOffsetX() : double
  +setStuckOffsetX(v: double) : void
  +update(dt: double) : void
  +left() : double
  +right() : double
  +top() : double
  +bottom() : double
  -radius : double
}

class Paddle {
  +update(dt: double) : void
  +getSpeed() : double
  +setSpeed(v: double) : void
  +setWidthBounds(min: double, max: double) : void
  +setWidthClamped(w: double) : void
  -speed : double
  -minWidth : double
  -maxWidth : double
}

class Brick {
  +update(dt: double) : void
  +getHealth() : int
  +setHealth(h: int) : void
  +isDestroyed() : boolean
  +isIndestructible() : boolean
  -health : int
}

class Bullet {
  +update(dt: double) : void
  +top() : double
  +bottom() : double
  +left() : double
  +right() : double
}

class PowerUp {
  +getType() : PowerUpType
  +isCollected() : boolean
  +markCollected() : void
  +update(dt: double) : void
  -type : PowerUpType
  -collected : boolean
}

class Enemy {
  +getType() : EnemyType
  +getVx() : double
  +setVx(v: double) : void
  +getVy() : double
  +setVy(v: double) : void
  +update(dt: double) : void
  -zigzagTimer : double
  -type : EnemyType
}

class InputState {
  +left : boolean
  +right : boolean
  +launch : boolean
  +fire : boolean
}

class RankingEntry {
  +getName() : String
  +getBestScore() : int
  +getBestRound() : int
  -name : String
  -bestScore : int
  -bestRound : int
}

class User {
  +getId() : int
  +getName() : String
  +getPasswordHash() : String
  +getBestScore() : int
  +getBestRound() : int
  +getLastLogin() : LocalDateTime
  -id : int
  -name : String
  -passwordHash : String
  -bestScore : int
  -bestRound : int
  -lastLogin : LocalDateTime
}

class DatabaseConfig {
  +getConnection() : Connection
  +close() : void
  -connection : Connection
}

class GameSettings {
  +isSoundEnabled() : boolean
  +setSoundEnabled(v: boolean) : void
  +getMasterVolume() : double
  +setMasterVolume(v: double) : void
  +getMusicVolume() : double
  +setMusicVolume(v: double) : void
  +getSfxVolume() : double
  +setSfxVolume(v: double) : void
  +getDifficulty() : Difficulty
  +setDifficulty(d: Difficulty) : void
  +getBallSpeedMultiplier() : double
  +getPaddleWidthMultiplier() : double
  +getHighScore() : int
  +setHighScore(score: int) : void
}

class GameEventBus {
  +getInstance() : GameEventBus
  +subscribe(type: Class, handler: Consumer) : Subscription
  +publish(event: Object) : void
}

class Subscription {
  +close() : void
}

GameObject <|-- MovableObject
MovableObject <|-- Ball
MovableObject <|-- Paddle
MovableObject <|-- Bullet
MovableObject <|-- PowerUp
MovableObject <|-- Enemy

Main --> SceneController : uses
SceneController --> GameController : creates
SceneController --> MenuController : creates
SceneController --> SettingsController : creates
SceneController --> LoginController : creates
SceneController --> SignupController : creates
SceneController --> RankingsController : creates
SceneController --> GameOverController : creates
SceneController --> WinController : creates

GameController --> GameService : uses
GameController --> GameState : uses
GameController --> SceneController : uses
GameController ..> GameStateSnapshot : capture/apply

MenuController ..> DatabaseService : uses
LoginController ..> DatabaseService : uses
SignupController ..> DatabaseService : uses
RankingsController ..> DatabaseService : uses

GameOverController --> SceneController : navigates
WinController --> SceneController : navigates

GameService o-- BallService
GameService o-- PaddleService
GameService o-- BricksService
GameService o-- PowerUpService
GameService o-- BulletService
GameService o-- EnemyService
GameService o-- RoundService
GameService --> GameState : mutates

RoundService o-- BricksService
RoundService o-- BallService
RoundService o-- PaddleService

BulletService --> GameState : uses
BulletService --> Bullet : uses
BulletService --> Brick : uses

BallService --> Ball : uses
BallService --> Paddle : uses
BallService --> GameObject : uses

PowerUpService --> GameState : uses
PowerUpService --> PowerUp : uses

EnemyService --> GameState : uses
EnemyService --> Enemy : uses

BricksService --> Brick : creates

DatabaseService ..> User : returns
DatabaseService ..> RankingEntry : returns
DatabaseService ..> GameStateSnapshot : uses

GameState --> Ball : has
GameState --> Paddle : has
GameState --> Brick : has many
GameState --> Bullet : has many
GameState --> PowerUp : has many
GameState --> Enemy : has many
